<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cut-Off – Painel Executivo</title>
<style>
  :root {
    --bg:#0b1020;
    --card:#121a33;
    --muted:#9aa4c0;
    --text:#e9ecf5;
    --line:#243055;
    --good:#22c55e;
    --warn:#f59e0b;
    --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#070a14);color:var(--text)}
  .wrap{max-width:1200px;margin:0 auto;padding:24px}
  .top{display:flex;align-items:flex-end;justify-content:space-between;gap:16px;flex-wrap:wrap}
  h1{margin:0;font-size:22px;letter-spacing:.2px}
  .sub{color:var(--muted);font-size:12px;margin-top:6px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  button{background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
  button:hover{border-color:#3a4a80}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px}
  .card{background:rgba(18,26,51,.92);border:1px solid rgba(36,48,85,.8);border-radius:14px;padding:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .kpi-title{color:var(--muted);font-size:12px}
  .kpi-value{font-size:22px;margin-top:8px;font-weight:700}
  .kpi-foot{margin-top:6px;color:var(--muted);font-size:12px}
  .row{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
  @media (max-width: 980px){ .grid{grid-template-columns:repeat(2,1fr)} .row{grid-template-columns:1fr} }
  .section-title{margin:18px 0 10px 0;font-size:14px;color:#d8ddf0}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
  .toolbar input, .toolbar select{background:#0f1730;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;min-width:240px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 10px;border-bottom:1px solid rgba(36,48,85,.8);font-size:12px;vertical-align:top}
  th{color:#cfd6f3;text-align:left;position:sticky;top:0;background:#0f1730;z-index:1;cursor:pointer}
  td{color:#e8ebf7}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:11px}
  .bar{height:10px;border-radius:999px;background:#0f1730;border:1px solid rgba(36,48,85,.8);overflow:hidden}
  .bar > span{display:block;height:100%;background:linear-gradient(90deg,#60a5fa,#22c55e);width:0%}
  .note{color:var(--muted);font-size:12px;line-height:1.4}
  .mini{font-size:11px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <div id="errorBox" style="display:none;background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.35);color:#fecaca;padding:10px 12px;border-radius:12px;margin-bottom:12px;font-size:12px;line-height:1.4"></div>

  <div class="top">
    <div>
      <h1>Cut-Off – Painel Executivo</h1>
      <div class="sub">Última atualização: <span id="updatedAt">—</span></div>
    </div>
    <div class="actions">
      <button onclick="window.print()">Exportar / Imprimir (PDF)</button>
    </div>
  </div>

  <div class="grid" id="kpiGrid"></div>

  <div class="row">
    <div class="card">
      <div class="section-title">Resumo histórico – Dezembro (anos anteriores)</div>
      <div class="note">Entregue vs. não entregue, mantendo o padrão de barras.</div>
      <div id="yearChart" style="margin-top:12px"></div>
      <div class="mini" style="margin-top:10px">Obs.: valores em R$.</div>
    </div>

    <div class="card">
      <div class="section-title">Janeiro – entregas por região</div>
      <div class="note">
        Colunas: Faturado, Entregue, % Entregue (Entregue ÷ Faturado), Pendente, Prev. Dez, Prev. Jan.
      </div>

      <div style="margin-top:12px;max-height:320px;overflow:auto;border-radius:12px;border:1px solid rgba(36,48,85,.8)">
        <table id="regTable">
          <thead>
            <tr>
              <th>Região</th>
              <th>Faturado</th>
              <th>Entregue</th>
              <th>%</th>
              <th>Pendente</th>
              <th>Prev. Dez</th>
              <th>Prev. Jan</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="mini" style="margin-top:10px">Ordem fixa: Sudeste, Nordeste, Sul, Centro-Oeste, Norte.</div>
    </div>
  </div>

  <!-- TABELA POR UF (VOLTOU) -->
  <div class="card" style="margin-top:12px">
    <div class="section-title">Detalhamento por UF</div>
    <div class="toolbar">
      <input id="q" placeholder="Buscar UF (ex.: SP)"/>
      <select id="sort">
        <option value="Pendente_desc">Ordenar: Pendente (desc)</option>
        <option value="PrevJan_desc">Ordenar: Previsto Jan (desc)</option>
        <option value="PrevDez_desc">Ordenar: Previsto Dez (desc)</option>
        <option value="PercEntregue_asc">Ordenar: % Entregue (asc)</option>
        <option value="ValorFaturado_desc">Ordenar: Valor faturado (desc)</option>
      </select>
      <span class="pill" id="countPill">—</span>
    </div>

    <div style="max-height:520px;overflow:auto;border-radius:12px;border:1px solid rgba(36,48,85,.8)">
      <table id="ufTable">
        <thead>
          <tr>
            <th data-k="UF">UF</th>
            <th data-k="ValorFaturado">Valor faturado</th>
            <th data-k="ValorEntregue">Valor entregue</th>
            <th data-k="PercEntregue">% entregue</th>
            <th data-k="Pendente">Pendente</th>
            <th data-k="PrevDez">Previsto Dez</th>
            <th data-k="PrevJan">Previsto Jan</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="mini" style="margin-top:10px">
      Regra: % entregue = Valor entregue ÷ Valor faturado. Arredondamento: 2 casas.
    </div>
  </div>

</div>

<script>
function brl(v){
  if(v===null || v===undefined || v==='') v=0;
  if(typeof v === 'string'){
    const cleaned = v.replace(/[^0-9,.-]/g,'').replace(/\./g,'').replace(',', '.');
    const parsed = Number(cleaned);
    v = Number.isFinite(parsed) ? parsed : 0;
  }
  return Number(v).toLocaleString('pt-BR', {style:'currency', currency:'BRL'});
}
function pctFromFrac(frac){
  const f = Number(frac || 0);
  return (f*100).toFixed(2).replace('.',',') + '%';
}
function frac(entregue, faturado){
  const e = Number(entregue || 0);
  const f = Number(faturado || 0);
  return f ? (e/f) : 0;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

async function load(){
  const url = `./data.json?v=${Date.now()}`;
  const showError = (msg) => {
    const box = document.getElementById('errorBox');
    box.style.display = 'block';
    box.textContent = msg;
  };

  try{
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(`Falha ao carregar data.json (HTTP ${r.status})`);
    const data = await r.json();

    // Schema esperado desta versão
    if(!data?.kpis || !Array.isArray(data?.historico_dezembro) || !Array.isArray(data?.regioes) || !Array.isArray(data?.uf)){
      throw new Error('Schema do data.json não confere com o HTML publicado. Atualize HTML e JSON em conjunto.');
    }

    document.getElementById('updatedAt').textContent = data.updated_at || '—';

    // KPIs (todos vindos do JSON)
    const k = data.kpis;
    const cards = [
      {t:'Valor faturado (Dez)', v: brl(k.valor_faturado_dez), f:'Fonte: JSON'},
      {t:'Valor entregue (Dez)', v: brl(k.valor_entregue_dez), f:'Fonte: JSON'},
      {t:'Entrega prevista – Dez', v: brl(k.entrega_prevista_dez), f:'Fonte: JSON'},
      {t:'Entrega prevista – Jan', v: brl(k.entrega_prevista_jan), f:'Fonte: JSON'}
    ];
    document.getElementById('kpiGrid').innerHTML = cards.map(c=>`
      <div class="card">
        <div class="kpi-title">${c.t}</div>
        <div class="kpi-value">${c.v}</div>
        <div class="kpi-foot">${c.f}</div>
      </div>
    `).join('');

    // Histórico (barras)
    renderYearChart(data.historico_dezembro);

    // Regiões (ordem fixa)
    renderRegioes(data.regioes);

    // UFs (tabela)
    setupUFTable(data.uf);

  } catch(err){
    console.error(err);
    showError(`Dados indisponíveis. Motivo: ${err.message}`);
    document.getElementById('updatedAt').textContent = '—';
    document.getElementById('kpiGrid').innerHTML = `
      <div class="card" style="grid-column:1/-1">
        <div class="kpi-title">Erro</div>
        <div class="kpi-value">—</div>
        <div class="kpi-foot">Publice o <b>index.html</b> e o <b>data.json</b> desta mesma versão.</div>
      </div>
    `;
  }
}

function renderYearChart(rows){
  const max = Math.max(...rows.map(r => (r.entregue||0) + (r.nao_entregue||0)), 1);
  const html = rows.sort((a,b)=>a.ano-b.ano).map(r=>{
    const total=(r.entregue||0)+(r.nao_entregue||0);
    const entPct = total ? ((r.entregue||0)/max)*100 : 0;
    return `
      <div style="margin:10px 0">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
          <div style="min-width:62px;font-weight:700">${r.ano}</div>
          <div style="flex:1">
            <div class="bar"><span style="width:${clamp(entPct,0,100)}%"></span></div>
            <div class="mini" style="margin-top:6px">
              Entregue: <b>${brl(r.entregue)}</b> • Não entregue: <b>${brl(r.nao_entregue)}</b> • Total: <b>${brl(total)}</b>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  document.getElementById('yearChart').innerHTML = html;
}

function renderRegioes(rows){
  const order = ['Sudeste','Nordeste','Sul','Centro-Oeste','Norte'];
  const byName = new Map(rows.map(r => [r.regiao, r]));
  const sorted = order.map(name => byName.get(name)).filter(Boolean);

  const tbody = document.querySelector('#regTable tbody');
  tbody.innerHTML = sorted.map(r=>{
    const f = frac(r.valor_entregue, r.valor_faturado);
    return `
      <tr>
        <td><b>${r.regiao}</b></td>
        <td>${brl(r.valor_faturado)}</td>
        <td>${brl(r.valor_entregue)}</td>
        <td>
          ${pctFromFrac(f)}
          <div class="bar" style="margin-top:6px"><span style="width:${clamp(f*100,0,100)}%"></span></div>
        </td>
        <td>${brl(r.valor_pendente)}</td>
        <td>${brl(r.previsto_dez)}</td>
        <td>${brl(r.previsto_jan)}</td>
      </tr>
    `;
  }).join('') || `<tr><td colspan="7" class="mini">Sem dados por região.</td></tr>`;
}

function setupUFTable(rows){
  // Normaliza e calcula % entregue em runtime
  const norm = rows.map(r=>{
    const vf = Number(r.ValorFaturado||0);
    const ve = Number(r.ValorEntregue||0);
    const p = vf ? (ve/vf) : 0;
    return {
      UF: r.UF,
      ValorFaturado: vf,
      ValorEntregue: ve,
      PercEntregue: p,
      Pendente: Number(r.Pendente||0),
      PrevDez: Number(r.PrevDez||0),
      PrevJan: Number(r.PrevJan||0),
    };
  });

  const tbody = document.querySelector('#ufTable tbody');
  const q = document.getElementById('q');
  const sort = document.getElementById('sort');
  const countPill=document.getElementById('countPill');

  function render(){
    const term = (q.value||'').trim().toUpperCase();
    let filtered = norm.filter(r=>!term || r.UF.toUpperCase().includes(term));
    const [k,dir] = sort.value.split('_');
    filtered.sort((a,b)=>{
      const av=a[k], bv=b[k];
      if(av===bv) return a.UF.localeCompare(b.UF);
      return dir==='desc' ? (bv-av) : (av-bv);
    });
    countPill.textContent = `${filtered.length} UFs`;

    tbody.innerHTML = filtered.map(r=>`
      <tr>
        <td><b>${r.UF}</b></td>
        <td>${brl(r.ValorFaturado)}</td>
        <td>${brl(r.ValorEntregue)}</td>
        <td>${pctFromFrac(r.PercEntregue)}</td>
        <td>${brl(r.Pendente)}</td>
        <td>${brl(r.PrevDez)}</td>
        <td>${brl(r.PrevJan)}</td>
      </tr>
    `).join('');
  }

  q.addEventListener('input', render);
  sort.addEventListener('change', render);

  // Clique no cabeçalho para ordenar
  document.querySelectorAll('#ufTable thead th[data-k]').forEach(th=>{
    th.addEventListener('click', ()=>{
      const k = th.getAttribute('data-k');
      const cur = sort.value;
      const curk = cur.split('_')[0];
      let dir = 'desc';
      if(curk===k && cur.endsWith('_desc')) dir='asc';
      sort.value = `${k}_${dir}`;
      render();
    });
  });

  render();
}

load();
</script>
</body>
</html>
